# SARDIP AI-Service ì•„í‚¤í…ì²˜ ì„¤ê³„ë„

## ğŸ“‹ ëª©ì°¨
1. [ì‹œìŠ¤í…œ ê°œìš”](#ì‹œìŠ¤í…œ-ê°œìš”)
2. [ì•„í‚¤í…ì²˜ ë‹¤ì´ì–´ê·¸ë¨](#ì•„í‚¤í…ì²˜-ë‹¤ì´ì–´ê·¸ë¨)
3. [ì£¼ìš” ì»´í¬ë„ŒíŠ¸](#ì£¼ìš”-ì»´í¬ë„ŒíŠ¸)
4. [ë°ì´í„° íë¦„](#ë°ì´í„°-íë¦„)
5. [API ì—”ë“œí¬ì¸íŠ¸](#api-ì—”ë“œí¬ì¸íŠ¸)
6. [ëª¨ë¸ êµ¬ì¡°](#ëª¨ë¸-êµ¬ì¡°)
7. [íŒŒì¼ êµ¬ì¡°](#íŒŒì¼-êµ¬ì¡°)

---

## ì‹œìŠ¤í…œ ê°œìš”

**SARDIP AI-Service**ëŠ” FastAPI ê¸°ë°˜ì˜ ì›ê²© ê°ì§€ ì´ë¯¸ì§€ ë¶„ì„ ì„œë¹„ìŠ¤ì…ë‹ˆë‹¤. Copernicus-FM Foundation Modelì„ í™œìš©í•˜ì—¬ ë‹¤ìŒê³¼ ê°™ì€ ì‘ì—…ì„ ìˆ˜í–‰í•©ë‹ˆë‹¤:

- **Segmentation (LULC)**: í† ì§€ ì´ìš©/í† ì§€ í”¼ë³µ ë¶„ë¥˜
- **Detection**: ê°ì²´ ê²€ì¶œ (ì„ ë°• ë“±)
- **Classification**: ì´ë¯¸ì§€ ë¶„ë¥˜

---

## ì•„í‚¤í…ì²˜ ë‹¤ì´ì–´ê·¸ë¨

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         Client (HTTP Request)                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    FastAPI Application Layer                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  main.py                                                  â”‚  â”‚
â”‚  â”‚  - /run-job (POST) - ë¹„ë™ê¸° ì‘ì—… ì‹¤í–‰                    â”‚  â”‚
â”‚  â”‚  - /run-job-sync (POST) - ë™ê¸° ì‘ì—… ì‹¤í–‰                 â”‚  â”‚
â”‚  â”‚  - /run-job-with-file (POST) - íŒŒì¼ ì—…ë¡œë“œ               â”‚  â”‚
â”‚  â”‚  - /run-job (GET) - Query íŒŒë¼ë¯¸í„° ë°©ì‹                 â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Request Processing Layer                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  process_job()                                            â”‚  â”‚
â”‚  â”‚  - Task íƒ€ì…ì— ë”°ë¥¸ ë¶„ê¸° ì²˜ë¦¬                            â”‚  â”‚
â”‚  â”‚  - BackgroundTasks ë˜ëŠ” ë™ê¸° ì‹¤í–‰                        â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚                         â”‚
                â–¼                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Segmentation Pipeline  â”‚  â”‚  Detection/Classification â”‚
â”‚                          â”‚  â”‚       Pipeline            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚                         â”‚
                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Data Loading & Preprocessing                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  load.py                                                  â”‚  â”‚
â”‚  â”‚  - load_s1_sar_image() - GeoTIFF/PIL ì´ë¯¸ì§€ ë¡œë“œ          â”‚  â”‚
â”‚  â”‚  - preprocess_s1_sar_data() - ì •ê·œí™” ë° ë¦¬ì‚¬ì´ì¦ˆ         â”‚  â”‚
â”‚  â”‚  - validate_s1_sar_data() - ë°ì´í„° ìœ íš¨ì„± ê²€ì‚¬          â”‚  â”‚
â”‚  â”‚  - get_image_metadata() - ë©”íƒ€ë°ì´í„° ì¶”ì¶œ                â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Model Inference Layer                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Segmentation:                                            â”‚  â”‚
â”‚  â”‚  - CopernicusFMEncoder (app/model/copernicus_encoder.py)  â”‚  â”‚
â”‚  â”‚  - SegmentationDecoder (app/model/segmentation_head.py)   â”‚  â”‚
â”‚  â”‚                                                           â”‚  â”‚
â”‚  â”‚  Detection/Classification:                                 â”‚  â”‚
â”‚  â”‚  - DualTaskWrapper (app/model/integrated_model.py)        â”‚  â”‚
â”‚  â”‚  - MultiTaskModel (Encoder + Multiple Heads)               â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Post-Processing & Analysis                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  lulc_analysis.py                                        â”‚  â”‚
â”‚  â”‚  - create_lulc_analysis() - í´ë˜ìŠ¤ë³„ í†µê³„ ê³„ì‚°           â”‚  â”‚
â”‚  â”‚  - create_analysis_result() - ë²”ìš© ë¶„ì„ ê²°ê³¼ ìƒì„±       â”‚  â”‚
â”‚  â”‚                                                           â”‚  â”‚
â”‚  â”‚  visualize.py                                            â”‚  â”‚
â”‚  â”‚  - create_3channel_visualization() - ì…ë ¥ ì´ë¯¸ì§€ ì‹œê°í™”  â”‚  â”‚
â”‚  â”‚  - create_color_mask() - ì»¬ëŸ¬ ë§ˆìŠ¤í¬ ìƒì„±                â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Storage Layer                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  storage.py                                              â”‚  â”‚
â”‚  â”‚  - save_mask_png() - PNG ë§ˆìŠ¤í¬ ì €ì¥                     â”‚  â”‚
â”‚  â”‚  - save_mask_tif() - GeoTIFF ë§ˆìŠ¤í¬ ì €ì¥                 â”‚  â”‚
â”‚  â”‚  - save_json() - ë¶„ì„ ê²°ê³¼ JSON ì €ì¥                     â”‚  â”‚
â”‚  â”‚  - get_output_directory() - ì¶œë ¥ ë””ë ‰í† ë¦¬ ê´€ë¦¬            â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Output Storage                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  /home/mjh/Project/LLM/RAG/ai-service/output/             â”‚  â”‚
â”‚  â”‚  â”œâ”€â”€ jobs/{job_id}/                                       â”‚  â”‚
â”‚  â”‚  â”‚   â”œâ”€â”€ input_3ch.png                                    â”‚  â”‚
â”‚  â”‚  â”‚   â”œâ”€â”€ mask_vis.png                                     â”‚  â”‚
â”‚  â”‚  â”‚   â””â”€â”€ mask_vis.tif                                     â”‚  â”‚
â”‚  â”‚  â”œâ”€â”€ {user_id}/{request_id}/                              â”‚  â”‚
â”‚  â”‚  â”‚   â”œâ”€â”€ {timestamp}_{sar_image_id}_{request_id}.png     â”‚  â”‚
â”‚  â”‚  â”‚   â””â”€â”€ {timestamp}_{sar_image_id}_{request_id}.json    â”‚  â”‚
â”‚  â”‚  â””â”€â”€ uploads/                                             â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ì£¼ìš” ì»´í¬ë„ŒíŠ¸

### 1. FastAPI Application (`app/main.py`)

**ì—­í• **: HTTP ìš”ì²­ ì²˜ë¦¬ ë° ë¼ìš°íŒ…

**ì£¼ìš” ê¸°ëŠ¥**:
- API ì—”ë“œí¬ì¸íŠ¸ ì •ì˜
- ìš”ì²­ ê²€ì¦ (Pydantic ëª¨ë¸)
- ë°±ê·¸ë¼ìš´ë“œ ì‘ì—… ê´€ë¦¬
- ëª¨ë¸ ì´ˆê¸°í™” ë° ë¡œë”©

**ì „ì—­ ë³€ìˆ˜**:
- `MODEL`: Detection/Classification ëª¨ë¸ (DualTaskWrapper)
- `SEGMENTATION_MODEL`: Segmentation ëª¨ë¸ íŠœí”Œ (encoder, decoder)

### 2. Model Layer (`app/model/`)

#### 2.1 CopernicusFMEncoder (`app/model/copernicus_encoder.py`)
- **ì—­í• **: Copernicus-FM Foundation Model ê¸°ë°˜ ì¸ì½”ë”
- **ì…ë ¥**: S1 SAR ì´ë¯¸ì§€ í…ì„œ [1, 2, H, W] (VV, VH ì±„ë„)
- **ì¶œë ¥**: 
  - Global features: [1, embed_dim]
  - Multi-scale features: List of [1, embed_dim, H', W']

#### 2.2 SegmentationDecoder (`app/model/segmentation_head.py`)
- **ì—­í• **: Multi-scale featuresë¥¼ segmentation maskë¡œ ë³€í™˜
- **ì…ë ¥**: Multi-scale features list
- **ì¶œë ¥**: Segmentation logits [1, num_classes, H, W]

#### 2.3 DualTaskWrapper (`app/model/integrated_model.py`)
- **ì—­í• **: Detection ë° Classification í†µí•© ëª¨ë¸
- **ê¸°ëŠ¥**: 
  - `predict_detection()`: ê°ì²´ ê²€ì¶œ
  - `predict_classification()`: ì´ë¯¸ì§€ ë¶„ë¥˜

### 3. Data Loading (`app/load.py`)

**ì£¼ìš” í•¨ìˆ˜**:
- `load_s1_sar_image()`: GeoTIFF ë˜ëŠ” ì¼ë°˜ ì´ë¯¸ì§€ ë¡œë“œ
- `preprocess_s1_sar_data()`: 
  - S1 SAR ë°ì´í„° ì •ê·œí™” (mean/std ê¸°ë°˜)
  - Quantile ê¸°ë°˜ outlier ì œê±°
  - ë¦¬ì‚¬ì´ì¦ˆ (256x256)
- `validate_s1_sar_data()`: ë°ì´í„° ìœ íš¨ì„± ê²€ì‚¬
- `get_image_metadata()`: GeoTIFF ë©”íƒ€ë°ì´í„° ì¶”ì¶œ

### 4. Analysis (`app/lulc_analysis.py`)

**ì£¼ìš” í•¨ìˆ˜**:
- `create_lulc_analysis()`: LULC í´ë˜ìŠ¤ë³„ í†µê³„ ê³„ì‚°
  - ë©´ì  ê³„ì‚° (mÂ²)
  - ë¹„ìœ¨ ê³„ì‚° (%)
  - í´ë˜ìŠ¤ ë§¤í•‘ (8ê°œ í´ë˜ìŠ¤)
- `create_analysis_result()`: ë²”ìš© ë¶„ì„ ê²°ê³¼ JSON ìƒì„±

### 5. Visualization (`app/visualize.py`)

**ì£¼ìš” í•¨ìˆ˜**:
- `create_3channel_visualization()`: VV, VH, Ratio ì±„ë„ ì‹œê°í™”
- `create_color_mask()`: í´ë˜ìŠ¤ë³„ ì»¬ëŸ¬ ë§ˆìŠ¤í¬ ìƒì„± (PNG/TIF)

### 6. Storage (`app/storage.py`)

**ì£¼ìš” í•¨ìˆ˜**:
- `save_mask_png()`: ì»¬ëŸ¬ ë§ˆìŠ¤í¬ PNG ì €ì¥
- `save_mask_tif()`: GeoTIFF ë§ˆìŠ¤í¬ ì €ì¥
- `save_json()`: ë¶„ì„ ê²°ê³¼ JSON ì €ì¥
- `get_output_directory()`: ì‚¬ìš©ìë³„ ì¶œë ¥ ë””ë ‰í† ë¦¬ ê´€ë¦¬

---

## ë°ì´í„° íë¦„

### Segmentation ì‘ì—… íë¦„

```
1. Client Request
   POST /run-job-sync
   {
     "task": "Segmentation",
     "input_ref": "/path/to/image.tif",
     "user_id": "user123",
     "request_id": "req456"
   }
   â”‚
   â–¼
2. Request Validation (Pydantic)
   RunJobIn ëª¨ë¸ ê²€ì¦
   â”‚
   â–¼
3. Data Loading
   load_s1_sar_image() â†’ [C, H, W] numpy array
   validate_s1_sar_data() â†’ ìœ íš¨ì„± ê²€ì‚¬
   â”‚
   â–¼
4. Preprocessing
   preprocess_s1_sar_data() â†’ [1, 2, 256, 256] tensor
   - Quantile ê¸°ë°˜ outlier ì œê±°
   - Mean/Std ì •ê·œí™”
   - ë¦¬ì‚¬ì´ì¦ˆ
   â”‚
   â–¼
5. Model Inference
   encoder(image_tensor) â†’ global_features, multi_scale_features
   decoder(multi_scale_features) â†’ seg_output [1, 8, 256, 256]
   torch.softmax() â†’ seg_probs
   torch.argmax() â†’ predicted_mask [256, 256]
   â”‚
   â–¼
6. Post-Processing
   create_lulc_analysis() â†’ í´ë˜ìŠ¤ë³„ í†µê³„ ê³„ì‚°
   create_3channel_visualization() â†’ ì…ë ¥ ì´ë¯¸ì§€ ì‹œê°í™”
   create_color_mask() â†’ ì»¬ëŸ¬ ë§ˆìŠ¤í¬ ìƒì„±
   â”‚
   â–¼
7. Storage
   save_mask_png() â†’ PNG íŒŒì¼ ì €ì¥
   save_json() â†’ ë¶„ì„ ê²°ê³¼ JSON ì €ì¥
   â”‚
   â–¼
8. Response
   {
     "job_id": "...",
     "status": "completed",
     "output_path": "...",
     "analysis_result": { ... }
   }
```

---

## API ì—”ë“œí¬ì¸íŠ¸

### 1. POST `/run-job`
**ë¹„ë™ê¸° ì‘ì—… ì‹¤í–‰**

**ìš”ì²­**:
```json
{
  "task": "Segmentation",
  "input_ref": "/path/to/image.tif",
  "params": {},
  "user_id": "user123",
  "request_id": "req456"
}
```

**ì‘ë‹µ**:
```json
{
  "job_id": "uuid",
  "accepted": true,
  "task": "Segmentation"
}
```

### 2. POST `/run-job-sync`
**ë™ê¸° ì‘ì—… ì‹¤í–‰ (ê²°ê³¼ ëŒ€ê¸°)**

**ìš”ì²­**: ë™ì¼

**ì‘ë‹µ**:
```json
{
  "job_id": "uuid",
  "task": "Segmentation",
  "status": "completed",
  "output_path": "/path/to/output.png",
  "analysis_result": {
    "metadata": { ... },
    "result": {
      "lulc_summary": { ... }
    }
  }
}
```

### 3. POST `/run-job-with-file`
**íŒŒì¼ ì—…ë¡œë“œ ë°©ì‹**

**ìš”ì²­**: `multipart/form-data`
- `task`: Task enum
- `file`: ì´ë¯¸ì§€ íŒŒì¼
- `user_id`, `request_id`, `sar_image_id`: ì„ íƒì 

**ì‘ë‹µ**: ë™ì¼

### 4. GET `/run-job`
**Query íŒŒë¼ë¯¸í„° ë°©ì‹**

**ìš”ì²­**: `?task=Segmentation&input_ref=/path/to/image.tif&...`

**ì‘ë‹µ**: ë™ì¼

---

## ëª¨ë¸ êµ¬ì¡°

### Segmentation ëª¨ë¸ êµ¬ì¡°

```
Input: S1 SAR Image [1, 2, 256, 256]
  â”‚
  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   CopernicusFMEncoder               â”‚
â”‚   - ViT Base (Classification)       â”‚
â”‚   - ViT Base (Segmentation)         â”‚
â”‚   - Multi-scale Feature Extraction  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â”œâ”€â†’ Global Features [1, 768]
               â”‚
               â””â”€â†’ Multi-scale Features:
                   â”œâ”€ Scale 1: [1, 768, 16, 16]
                   â”œâ”€ Scale 2: [1, 768, 8, 8]
                   â”œâ”€ Scale 4: [1, 768, 4, 4]
                   â””â”€ Scale 8: [1, 768, 2, 2]
                   â”‚
                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   SegmentationDecoder               â”‚
â”‚   - FPN-like Feature Fusion        â”‚
â”‚   - Upsampling                      â”‚
â”‚   - Classification Head            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â–¼
Output: Segmentation Logits [1, 8, 256, 256]
  â”‚
  â–¼
Softmax â†’ Probabilities
  â”‚
  â–¼
Argmax â†’ Predicted Mask [256, 256]
```

### í´ë˜ìŠ¤ ë§¤í•‘ (LULC)

| Class ID | Label | Color |
|----------|-------|-------|
| 0 | Background | Black |
| 1 | Forest | Green |
| 2 | Shrubland | Olive |
| 3 | Grassland | Light Green |
| 4 | Wetland | Sky Blue |
| 5 | Cropland | Orange |
| 6 | Urban/Built-up | Gray |
| 7 | Barren | Brown |
| 8 | Water | Blue |

---

## íŒŒì¼ êµ¬ì¡°

```
ai-service/
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ main.py                 # FastAPI ì• í”Œë¦¬ì¼€ì´ì…˜
â”‚   â”œâ”€â”€ model.py                # ëª¨ë¸ ë ˆí¼ (í˜¸í™˜ì„±)
â”‚   â”œâ”€â”€ load.py                 # ë°ì´í„° ë¡œë”© ë° ì „ì²˜ë¦¬
â”‚   â”œâ”€â”€ storage.py               # ê²°ê³¼ ì €ì¥
â”‚   â”œâ”€â”€ lulc_analysis.py        # LULC ë¶„ì„
â”‚   â”œâ”€â”€ visualize.py            # ì‹œê°í™”
â”‚   â”œâ”€â”€ paths.py                # ê²½ë¡œ ì„¤ì •
â”‚   â”œâ”€â”€ copernicus_example.py   # ì˜ˆì œ ì½”ë“œ
â”‚   â””â”€â”€ model/
â”‚       â”œâ”€â”€ __init__.py
â”‚       â”œâ”€â”€ integrated_model.py      # í†µí•© ëª¨ë¸
â”‚       â”œâ”€â”€ copernicus_encoder.py   # Copernicus-FM ì¸ì½”ë”
â”‚       â”œâ”€â”€ segmentation_head.py    # Segmentation ë””ì½”ë”
â”‚       â”œâ”€â”€ classification_head.py  # Classification í—¤ë“œ
â”‚       â”œâ”€â”€ detection_head.py       # Detection í—¤ë“œ
â”‚       â”œâ”€â”€ encoder.py              # ê¸°ë³¸ ì¸ì½”ë”
â”‚       â””â”€â”€ upernet_decoder.py      # UperNet ë””ì½”ë”
â”œâ”€â”€ weights/                    # ëª¨ë¸ ê°€ì¤‘ì¹˜
â”œâ”€â”€ output/                     # ì¶œë ¥ íŒŒì¼
â”‚   â”œâ”€â”€ jobs/                   # ì‘ì—…ë³„ ì„ì‹œ íŒŒì¼
â”‚   â””â”€â”€ uploads/                 # ì—…ë¡œë“œëœ íŒŒì¼
â”œâ”€â”€ DockerFile/                 # Docker ì„¤ì •
â”œâ”€â”€ requirements.txt            # Python íŒ¨í‚¤ì§€ ì˜ì¡´ì„±
â”œâ”€â”€ test_segmentation.py        # í…ŒìŠ¤íŠ¸ ìŠ¤í¬ë¦½íŠ¸
â””â”€â”€ ARCHITECTURE.md             # ì´ ë¬¸ì„œ
```

---

## í™˜ê²½ ë³€ìˆ˜

```bash
# NAS ê²½ë¡œ (ê¸°ë³¸ê°’: /home/mjh/Project/LLM/RAG/ai-service/output)
NAS_ROOT=/path/to/nas

# ëª¨ë¸ ê°€ì¤‘ì¹˜ ê²½ë¡œ (ê¸°ë³¸ê°’: /home/mjh/Project/LLM/RAG/ai-service/weights)
MODEL_WEIGHTS_DIR=/path/to/weights

# Detection ëª¨ë¸ ê°€ì¤‘ì¹˜ ê²½ë¡œ
WEIGHTS_PATH=/path/to/detection/weights
```

---

## ì‹œì‘í•˜ê¸°

### 1. ì˜ì¡´ì„± ì„¤ì¹˜
```bash
pip install -r requirements.txt
```

### 2. ëª¨ë¸ ê°€ì¤‘ì¹˜ ì¤€ë¹„
- Copernicus-FM ê°€ì¤‘ì¹˜: `CopernicusFM_ViT_base_varlang_e100.pth`
- Segmentation ë””ì½”ë”: `s1_seg.ckpt`
- Detection ëª¨ë¸ ê°€ì¤‘ì¹˜: `WEIGHTS_PATH` í™˜ê²½ë³€ìˆ˜ë¡œ ì§€ì •

### 3. ì„œë²„ ì‹¤í–‰
```bash
cd /home/mjh/Project/LLM/RAG/ai-service
uvicorn app.main:app --host 192.168.10.174 --port 6600
```

### 4. API í…ŒìŠ¤íŠ¸
```bash
curl -X POST "http://192.168.10.174:6600/run-job-sync" \
     -H "Content-Type: application/json" \
     -d '{
       "task": "Segmentation",
       "input_ref": "/path/to/image.tif",
       "user_id": "test_user",
       "request_id": "test_req"
     }'
```

---

## ê¸°ìˆ  ìŠ¤íƒ

- **Framework**: FastAPI 0.104+
- **ML Framework**: PyTorch 2.0+
- **Foundation Model**: Copernicus-FM
- **Image Processing**: PIL, rasterio
- **Data Validation**: Pydantic 2.0+
- **Server**: Uvicorn

---

## ì£¼ìš” íŠ¹ì§•

1. **ë¹„ë™ê¸° ì²˜ë¦¬**: BackgroundTasksë¥¼ í†µí•œ ë¹„ë™ê¸° ì‘ì—… ì‹¤í–‰
2. **ë™ê¸° ì²˜ë¦¬**: `/run-job-sync` ì—”ë“œí¬ì¸íŠ¸ë¡œ ê²°ê³¼ ëŒ€ê¸°
3. **íŒŒì¼ ì—…ë¡œë“œ**: multipart/form-data ì§€ì›
4. **ë©”íƒ€ë°ì´í„° ì¶”ì¶œ**: GeoTIFF ë©”íƒ€ë°ì´í„° ìë™ ì¶”ì¶œ
5. **ì‚¬ìš©ìë³„ ì¶œë ¥**: user_id/request_id ê¸°ë°˜ ë””ë ‰í† ë¦¬ êµ¬ì¡°
6. **ë‹¤ì–‘í•œ ì¶œë ¥ í˜•ì‹**: PNG, GeoTIFF, JSON ì§€ì›

---

## í–¥í›„ ê°œì„  ì‚¬í•­

- [ ] ë°°ì¹˜ ì²˜ë¦¬ ì§€ì›
- [ ] ëª¨ë¸ ë²„ì „ ê´€ë¦¬
- [ ] ê²°ê³¼ ìºì‹±
- [ ] ëª¨ë‹ˆí„°ë§ ë° ë¡œê¹… ê°•í™”
- [ ] ì¸ì¦/ì¸ê°€ ì¶”ê°€
- [ ] WebSocketì„ í†µí•œ ì‹¤ì‹œê°„ ì§„í–‰ ìƒí™© ì „ì†¡

