# InSAR ìƒˆë¡œìš´ ì ‘ê·¼ ë°©ì‹ (ì‚¬ìš©ì ì œì•ˆ)

## ğŸ¯ í•µì‹¬ ì•„ì´ë””ì–´

**InSARì˜ í•„ìˆ˜ ì¡°ê±´**: Master + Slave ê²½ë¡œ (2ê°œ íŒŒì¼)

### ì˜ì‚¬ê²°ì • íŠ¸ë¦¬
```
ì‚¬ìš©ì: "InSAR í•´ì¤˜"
   â†“
LLM Intent: sar_insar_processing
   â†“
run_insar: Master/Slave ê²½ë¡œ ì²´í¬
   â†“
   â”œâ”€ âœ… ê²½ë¡œ ìˆìŒ â†’ ë°”ë¡œ ì‹¤í–‰
   â””â”€ âŒ ê²½ë¡œ ì—†ìŒ â†’ Retrieval Routerë¡œ ë¼ìš°íŒ…
         â†“
      download_sar: ìë™ ë°ì´í„° ê²€ìƒ‰/ë‹¤ìš´ë¡œë“œ
         â†“
      "ë°ì´í„° ë°›ê³  InSAR ì§„í–‰í• ê¹Œìš”?" (ì‚¬ìš©ì í™•ì¸)
         â†“
      ì‚¬ìš©ì: "ë„¤"
         â†“
      run_insar: ì‹¤í–‰
```

---

## ğŸ“‹ ì¼€ì´ìŠ¤ë³„ í”Œë¡œìš°

### âœ… ì¼€ì´ìŠ¤ 1: ì§ì ‘ ê²½ë¡œ ì œê³µ (Master/Slave ëª…ì‹œ)
```
ì‚¬ìš©ì: "/mnt/sar/file1.zipëŠ” master
        /mnt/sar/file2.zipëŠ” slaveë¡œ
        D-InSAR ê²°ê³¼ ì•Œê³  ì‹¶ì–´ìš”"
```

**í”Œë¡œìš°:**
1. LLM Intent: `sar_insar_processing`
2. `run_insar`: Master/Slave ê²½ë¡œ ì¶”ì¶œ
   - Master: `/mnt/sar/file1.zip` âœ…
   - Slave: `/mnt/sar/file2.zip` âœ…
3. **ë°”ë¡œ ì‹¤í–‰** (Retrieval Router ì•ˆ ê°)

**í„´ ìˆ˜:** 1í„´

---

### âœ… ì¼€ì´ìŠ¤ 2: ê²½ë¡œë§Œ ì œê³µ (Master/Slave êµ¬ë¶„ ì—†ìŒ)
```
ì‚¬ìš©ì: "/mnt/sar/file1.zip
        /mnt/sar/file2.zip
        InSAR í•´ì¤˜"
```

**í”Œë¡œìš°:**
1. LLM Intent: `sar_insar_processing`
2. `run_insar`: ê²½ë¡œ 2ê°œ ì¶”ì¶œ
   - File 1: `/mnt/sar/file1.zip` âœ…
   - File 2: `/mnt/sar/file2.zip` âœ…
   - **ë‚ ì§œ ê¸°ì¤€ ìë™ ì •ë ¬** (ë¹ ë¥¸ ê²ƒ = Master, ëŠ¦ì€ ê²ƒ = Slave)
3. **ë°”ë¡œ ì‹¤í–‰**

**í„´ ìˆ˜:** 1í„´

---

### âœ… ì¼€ì´ìŠ¤ 3: í´ë” ê²½ë¡œ ì œê³µ
```
ì‚¬ìš©ì: "/mnt/sar/Dataset í´ë”ë¡œ InSAR í•´ì¤˜"
```

**í”Œë¡œìš°:**
1. LLM Intent: `sar_insar_processing`
2. `run_insar`: í´ë” ê²½ë¡œ ì¶”ì¶œ
   - í´ë” ìŠ¤ìº” â†’ 2ê°œ SAFE íŒŒì¼ ì°¾ê¸°
   - **ë‚ ì§œ ê¸°ì¤€ ìë™ ì •ë ¬**
3. **ë°”ë¡œ ì‹¤í–‰**

**í„´ ìˆ˜:** 1í„´

---

### âœ… ì¼€ì´ìŠ¤ 4: ë‹¤ìš´ë¡œë“œ í›„ InSAR (ê¸°ì¡´ ë°©ì‹)
```
ì‚¬ìš©ì: "ë‰´ì§ˆëœë“œ ë§ˆìš° ê¸°ì¦ˆ 2023ë…„ 11ì›” 24ì¼ ë°ì´í„° ê°€ì ¸ì™€ì¤˜"
       (ë‹¤ìš´ë¡œë“œ ì™„ë£Œ)
ì‚¬ìš©ì: "InSAR í•´ì¤˜"
```

**í”Œë¡œìš°:**
1. **1ë²ˆì§¸ ì§ˆë¬¸**: SAR ë°ì´í„° ë‹¤ìš´ë¡œë“œ (2ê°œ)
   - `downloaded_sar_files` ì €ì¥
2. **2ë²ˆì§¸ ì§ˆë¬¸**: LLM Intent: `sar_insar_processing`
3. `run_insar`: `downloaded_sar_files` í™•ì¸
   - File 1: `S1A_...zip` âœ…
   - File 2: `S1A_...zip` âœ…
4. **ë°”ë¡œ ì‹¤í–‰**

**í„´ ìˆ˜:** 2í„´ (ë‹¤ìš´ë¡œë“œ 1í„´ + InSAR 1í„´)

---

### âœ… ì¼€ì´ìŠ¤ 5: ë°ì´í„° ì—†ìŒ â†’ ìë™ ê²€ìƒ‰/ë‹¤ìš´ë¡œë“œ (NEW! â­)
```
ì‚¬ìš©ì: "íŠ€ë¥´í‚¤ì˜ˆ ê°€ì§€ì•ˆí…Œí”„ì£¼ 2023ë…„ 2ì›” 6ì¼ ì§€ì§„ InSAR ë¶„ì„í•´ì¤˜"
```

**í”Œë¡œìš°:**
1. LLM Intent: `sar_insar_processing`
2. `run_insar`: Master/Slave ê²½ë¡œ ì²´í¬
   - âŒ ê²½ë¡œ ì—†ìŒ
   - âœ… ì§€ì—­ëª… + ë‚ ì§œ ìˆìŒ
3. **Retrieval Routerë¡œ ë¼ìš°íŒ…** (`download_sar`)
4. `download_sar`: ìë™ ë°ì´í„° ê²€ìƒ‰
   - ğŸ“ ì§€ì—­: ê°€ì§€ì•ˆí…Œí”„ì£¼ (ì¢Œí‘œ ì¶”ì¶œ)
   - ğŸ“… ë‚ ì§œ: 2023-02-06 (Â±2ë…„ ë²”ìœ„)
   - ğŸ” ê²€ìƒ‰ â†’ 10ê°œ ë°œê²¬
   - **ìë™ìœ¼ë¡œ ì´ë²¤íŠ¸ ë‚ ì§œ ì „í›„ 2ê°œ ì„ íƒ** (Master/Slave)
5. ë‹¤ìš´ë¡œë“œ ì™„ë£Œ
6. AI: "âœ… 2ê°œ ë°ì´í„° ë‹¤ìš´ë¡œë“œ ì™„ë£Œ! InSAR ì§„í–‰í• ê¹Œìš”?"
7. ì‚¬ìš©ì: "ë„¤"
8. `run_insar`: ì‹¤í–‰

**í„´ ìˆ˜:** 2í„´ (ìë™ ë‹¤ìš´ë¡œë“œ 1í„´ + ì‚¬ìš©ì í™•ì¸ 1í„´)

---

### âŒ ì¼€ì´ìŠ¤ 6: ë°ì´í„° ì—†ìŒ + ì •ë³´ ë¶€ì¡±
```
ì‚¬ìš©ì: "InSAR í•´ì¤˜"
```

**í”Œë¡œìš°:**
1. LLM Intent: `sar_insar_processing`
2. `run_insar`: Master/Slave ê²½ë¡œ ì²´í¬
   - âŒ ê²½ë¡œ ì—†ìŒ
   - âŒ ì§€ì—­ëª… ì—†ìŒ
   - âŒ ë‚ ì§œ ì—†ìŒ
3. **ì—ëŸ¬ ë©”ì‹œì§€ ì¶œë ¥**
   ```
   âŒ InSAR ì²˜ë¦¬ë¥¼ ìœ„í•œ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.
   
   ë‹¤ìŒ ë°©ë²• ì¤‘ í•˜ë‚˜ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”:
   1ï¸âƒ£ íŒŒì¼ ê²½ë¡œ ì§ì ‘ ì œê³µ
   2ï¸âƒ£ í´ë” ê²½ë¡œ ì œê³µ
   3ï¸âƒ£ ì§€ì—­ëª… + ë‚ ì§œ ì œê³µ (ìë™ ê²€ìƒ‰)
   ```

**í„´ ìˆ˜:** 1í„´ (ì—ëŸ¬)

---

## ğŸ”„ Graph êµ¬ì¡° ë³€ê²½

### í˜„ì¬ êµ¬ì¡° (ì˜µì…˜ B)
```
web_search â†’ run_insar (ë°”ë¡œ ì‹¤í–‰)
```

### ìƒˆë¡œìš´ êµ¬ì¡° (ì œì•ˆ)
```
web_search â†’ run_insar
   â†“
   â”œâ”€ ê²½ë¡œ ìˆìŒ â†’ END (ì‹¤í–‰)
   â””â”€ ê²½ë¡œ ì—†ìŒ + ì§€ì—­/ë‚ ì§œ ìˆìŒ â†’ download_sar
         â†“
      ë‹¤ìš´ë¡œë“œ ì™„ë£Œ + ì‚¬ìš©ì í™•ì¸ ëŒ€ê¸°
         â†“
      ì‚¬ìš©ì: "ë„¤" â†’ run_insar â†’ END
```

**í•µì‹¬ ë³€ê²½:**
1. `run_insar`ê°€ ì¡°ê±´ë¶€ ë¼ìš°íŒ… ê°€ëŠ¥í•´ì•¼ í•¨ (END or download_sar)
2. `download_sar` ì™„ë£Œ í›„ ì‚¬ìš©ì í™•ì¸ ë‹¨ê³„ ì¶”ê°€
3. í™•ì¸ í›„ ë‹¤ì‹œ `run_insar`ë¡œ ë¼ìš°íŒ…

---

## ğŸ› ï¸ êµ¬í˜„ í•„ìš” ì‚¬í•­

### 1. `graph.py` - ì¡°ê±´ë¶€ ë¼ìš°íŒ… ì¶”ê°€
```python
def route_after_run_insar(state):
    """
    run_insar ì´í›„ ë¼ìš°íŒ…:
    - ì‹¤í–‰ ì™„ë£Œ â†’ END
    - ë°ì´í„° ì—†ìŒ â†’ download_sar (ìë™ ê²€ìƒ‰)
    - ì—ëŸ¬ â†’ END
    """
    sar_result = state.get("sar_result", {})
    status = sar_result.get("status")
    
    if status == "need_download":
        return "download_sar"
    else:
        return END

workflow.add_conditional_edges(
    "run_insar",
    route_after_run_insar,
    {
        "download_sar": "download_sar",
        END: END,
    }
)
```

### 2. `insar_processing.py` - ë°ì´í„° ì—†ìŒ ì‹œ ë¼ìš°íŒ…
```python
def run_insar(state):
    # ... (ê¸°ì¡´ ê²½ë¡œ ì²´í¬ ë¡œì§)
    
    # ê²½ë¡œ ì—†ìŒ + ì§€ì—­/ë‚ ì§œ ìˆìŒ â†’ ìë™ ë‹¤ìš´ë¡œë“œ íŠ¸ë¦¬ê±°
    if not safe_files and (location_name or coordinates):
        print("âœ… ë°ì´í„° ì—†ìŒ â†’ ìë™ ë‹¤ìš´ë¡œë“œ íŠ¸ë¦¬ê±°")
        return {
            "sar_result": {
                "status": "need_download",
                "message": "ë°ì´í„° ê²€ìƒ‰ ì¤‘..."
            },
            # download_sarì— í•„ìš”í•œ ì •ë³´ ì „ë‹¬
            "auto_insar_after_download": True,  # í”Œë˜ê·¸
        }
    
    # ê²½ë¡œ ì—†ìŒ + ì •ë³´ ë¶€ì¡± â†’ ì—ëŸ¬
    if not safe_files:
        return {
            "generation": error_msg,
            "sar_result": {
                "status": "error",
                "message": error_msg
            }
        }
```

### 3. `download_node.py` - ìë™ InSAR í”Œë˜ê·¸ ì²˜ë¦¬
```python
def download_sar(state):
    auto_insar = state.get("auto_insar_after_download", False)
    
    # ... (ê¸°ì¡´ ë‹¤ìš´ë¡œë“œ ë¡œì§)
    
    if auto_insar:
        # InSARìš© ìë™ ë‹¤ìš´ë¡œë“œ
        # ì´ë²¤íŠ¸ ë‚ ì§œ ì „í›„ 2ê°œ ìë™ ì„ íƒ
        selected_indices = auto_select_for_insar(products, event_date)
        
        # ë‹¤ìš´ë¡œë“œ ì‹¤í–‰
        download_results = ...
        
        # ì‚¬ìš©ì í™•ì¸ ìš”ì²­
        return {
            "generation": "âœ… 2ê°œ ë°ì´í„° ë‹¤ìš´ë¡œë“œ ì™„ë£Œ! InSAR ì§„í–‰í• ê¹Œìš”?",
            "downloaded_sar_files": [...],
            "awaiting_insar_confirmation": True,  # ìƒˆ í”Œë˜ê·¸
        }
```

### 4. `main_router` - í™•ì¸ í”Œë˜ê·¸ ì²´í¬
```python
def main_router(state):
    awaiting_insar = state.get("awaiting_insar_confirmation", False)
    
    if awaiting_insar:
        # ì‚¬ìš©ìê°€ "ë„¤", "yes", "ì§„í–‰" ë“±ì„ ì…ë ¥í•˜ë©´
        if is_positive_response(question):
            return "sar_processing"  # run_insarë¡œ
        else:
            return "retrieval"  # ì·¨ì†Œ ë˜ëŠ” ë‹¤ë¥¸ ìš”ì²­
    
    # ... (ê¸°ì¡´ ë¡œì§)
```

---

## ğŸ“Š ë¹„êµ: ì˜µì…˜ B vs ìƒˆ ì œì•ˆ

| í•­ëª© | ì˜µì…˜ B | ìƒˆ ì œì•ˆ |
|-----|-------|---------|
| **ê²½ë¡œ ì œê³µ ì‹œ** | 1í„´ âœ… | 1í„´ âœ… |
| **ë‹¤ìš´ë¡œë“œ í›„** | 1í„´ âœ… | 1í„´ âœ… |
| **ì§€ì—­+ë‚ ì§œ ìë™** | ì—ëŸ¬ âŒ | 2í„´ (ìë™ ë‹¤ìš´ë¡œë“œ) âœ… |
| **ìë™í™”** | ë¶€ë¶„ì  | ì™„ì „ â­ |
| **ì‚¬ìš©ì í™•ì¸** | ì—†ìŒ | ìˆìŒ (ì•ˆì „) |
| **êµ¬ì¡° ë³µì¡ë„** | ì¤‘ê°„ | ë†’ìŒ |
| **ì‚¬ìš©ì ê²½í—˜** | ì¢‹ìŒ | ë§¤ìš° ì¢‹ìŒ â­ |

---

## âœ… ì œì•ˆ ìˆ˜ìš© ì—¬ë¶€

**ì¶”ì²œ: ìƒˆ ì œì•ˆ ìˆ˜ìš© â­**

**ì´ìœ :**
1. âœ… ì™„ì „í•œ ìë™í™” (ì§€ì—­+ë‚ ì§œë§Œ ì£¼ë©´ ë)
2. âœ… ëª…í™•í•œ ì˜ì‚¬ê²°ì • íŠ¸ë¦¬
3. âœ… ì‚¬ìš©ì í™•ì¸ ë‹¨ê³„ (ì•ˆì „)
4. âœ… ì§ê´€ì ì¸ í”Œë¡œìš°
5. âš ï¸ êµ¬í˜„ ë³µì¡ë„ëŠ” ë†’ì§€ë§Œ ê°€ì¹˜ ìˆìŒ

**ë‹¤ìŒ ë‹¨ê³„:**
ì˜µì…˜ B â†’ ìƒˆ ì œì•ˆìœ¼ë¡œ ë¦¬íŒ©í† ë§í• ê¹Œìš”?

---

**ìƒì„±ì¼:** 2026-02-05  
**ë²„ì „:** 1.0
